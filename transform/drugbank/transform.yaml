class: Playbook
name: "rawDrugBank"

schema: ../../src/bmeg/bmeg-dictionary/gdcdictionary/schemas/

inputs:
  drugBank:
    type: File
    default: ../../source/drugbank/full_database.xml

steps:
  - xmlLoad:
      input: "{{inputs.drugBank}}"
      transform:
          - map:
              python: >
                def f(x):
                  pubchem = x['drug']['external-identifiers']['external-identifier']['identifier']
                  if pubchem != 'PubChem Substance':
                      pubchem = ''
                  x['drug']['external-identifiers']['external-identifier']['identifier'] = pubchem
                  return x
              method: f
          # TODO add filter to ignore messages without pubchem_id == ''
          - fork:
              transform:
                -
                  - project:
                      # TODO update submitter_id
                      # TODO update "temp_placeholder"
                      mapping:
                          project_id: "Project:Drugbank"
                          submitter_id: "temp_placeholder"
                          association_type: "{{row.drug.targets.target.actions.action}}"
                          type: drug_gene
                  - objectCreate:
                      class: association
                -
                  - project:
                      mapping:
                          project_id: "Project:Drugbank"
                          submitter_id: "temp_placeholder"
                          pubchem_id: "{{row.drug.external-identifiers.external-identifier.identifier}}"
                          type: "{{row.drug.external-identifiers.external-identifier.resource}}"
                  - objectCreate:
                      class: compound
                -
                #   - project:
                #       mapping:
                #           project_id: "Project:Drugbank"
                #           submitter_id: "temp_placeholder"
                #           # TODO filter out for only gene symbols
                #           symbol: "{{row.drug.targets.target.polypeptide.gene-name]}}"
                #           description: "temp_placeholder" # "{{row.drug.targets.target.polypeptide.general-function]}}"
                #           chromosome: "temp_placeholder" # "{{row.drug.targets.target.polypeptide.chromosome-location]}}"
                #           strand: "temp_placeholder"
                #           start: "temp_placeholder"
                #           genome: "temp_placeholder"
                #           end: "temp_placeholder"
                #           gene_id: "temp_placeholder"
                #   - objectCreate:
                #       class: gene
                # -
                  - project:
                      mapping:
                          project_id: "Project:Drugbank"
                          submitter_id: "temp_placeholder"
                          project_id: "temp_placeholder"
                          protein_id: "{{row.drug.targets.target.id}}"
                          genome: "temp_placeholder"
                  - objectCreate:
                      class: protein
                -
                  - project:
                      mapping:
                          project_id: "Project:Drugbank"
                          submitter_id: "temp_placeholder"
                          url: "http://ncbi.nlm.nih.gov/pubmed/{{row.drug.targets.target.references.articles.article.pubmed-id}}"
                  - objectCreate:
                      class: publication
