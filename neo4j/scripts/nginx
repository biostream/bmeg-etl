# bolt streaming
stream {
  server {
          listen 7687;
          proxy_pass 10.50.50.229:7687;
  }
}


# HTTP (not SSL/TLS) server
server {
	listen 80 default_server;
	listen [::]:80 default_server;
  server_name neo4j.compbio.ohsu.edu;
	return 301 https://$server_name$request_uri;
}




stream {
    upstream websockets {
        ## neo4j server in background
        server 10.50.50.229:7687;
        check interval=3000 rise=2 fall=5 timeout=1000;
    }
    server {
      server_name _;
      listen 7687;
      ssl on;

      ssl_certificate /home/ubuntu/exa/secrets/compbio-tls/compbio_ohsu_edu_interm2.cer;
      ssl_certificate_key /home/ubuntu/exa/secrets/compbio-tls/wild.compbio.ohsu.edu.key;
      client_max_body_size 20M;

      timeout 43200000;
      websocket_connect_timeout 43200000;
      proxy_connect_timeout 43200000;

      so_keepalive on;
      tcp_nodelay on;

      websocket_pass websockets;
      websocket_buffer 1k;
     }
}








map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

upstream neo4j {
    server 10.50.50.229:7687;
}

server {
    listen 7687; // client_wss_port

    ssl on;
    ssl_certificate /home/ubuntu/exa/secrets/compbio-tls/compbio_ohsu_edu_interm2.cer;
    ssl_certificate_key /home/ubuntu/exa/secrets/compbio-tls/wild.compbio.ohsu.edu.key;


    location / {
        proxy_pass http://neo4j;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
